## RDB（保存键值对）

### 手动保存

#### 命令
- **save：** `阻塞主线程`，直到rdb快照文件生成
- **bgsave（COW）：**
    - fork一个子线程（刚开始的时候与主线程使用同一个内存空间，短暂阻塞主线程）
    - 子线程遍历内存数据，并写入到rdb文件中
    - 共享的内存空间用页/块分段，当主线程需要写入时，复制一个页/块空间，并在上面做修改，待子线程写完快照后，再替换掉旧的页/块空间

#### 命令冲突
- save和bgsave不能同时执行
- bgrewriteaof执行时，bgsave会被拒绝
- bgsave执行时，bgrewriteaof会延后执行

### 自动保存

#### 执行原理
- serverCron默认每100ms执行一次，校验每个库的dirty计数器和lastsave属性，是否满足任一配置的save
- dirty计数器--记录修改次数
- lastsave--记录最近一次修改的时间戳

#### 配置

    save 900 1           #在900秒(15分钟)之后，如果至少有1个key发生变化，Redis就会自动触发BGSAVE命令创建快照。
    save 300 10          #在300秒(5分钟)之后，如果至少有10个key发生变化，Redis就会自动触发BGSAVE命令创建快照。
    save 60 10000        #在60秒(1分钟)之后，如果至少有10000个key发生变化，Redis就会自动触发BGSAVE命令创建快照。
    save ""              #关闭自动保存

### 载入
- 每次redis启动的时候，会先看有无aof，有则用aof重载数据，无则用rdb载入数据
- rdb载入数据的速度比aof快
- rdb载入数据的时候会阻塞线程（bgsave）

## AOF（保存操作语句）

### 自动保存

#### 执行原理
- 追加到缓存--将操作成功的语句，追加到aof_buf缓冲区中
- 写入和同步文件--根据配置的策略，将缓存区的数据写入硬盘中

#### 配置

    appendonly yes              #开启/关闭AOF
    appendfsync always          #每次有数据修改发生时都会写入AOF文件,这样会严重降低Redis的速度
    appendfsync everysec        #每秒钟同步一次，显示地将多个写命令同步到硬盘
    appendfsync no              #让操作系统决定何时进行同步

### AOF重写

#### 手动重写
- bgrewriteaof

#### 自动重写

##### 原理
- 服务器在AOF功能开启的情况下，会维持以下三个变量：
    - 记录当前AOF文件大小的变量aof_current_size
    - 记录最后一次AOF重写之后，AOF文件大小的变量aof_rewrite_base_size
    - 增长百分比变量aof_rewrite_perc
- 每次当serverCron（服务器周期性操作函数）函数执行时，它会检查以下条件是否全部满足，如果全部满足的话，就触发自动的AOF重写操作：
    - 没有BGSAVE命令（RDB持久化）/AOF持久化在执行
    - 没有BGREWRITEAOF在进行
    - 当前AOF文件大小要大于auto-aof-rewrite-min-size
    - 当前AOF文件大小和最后一次重写后的大小之间的比率大于或者等于指定的增长百分比auto-aof-rewrite-percentage

#### 过程（COW）
- fork一个子线程（刚开始的时候与主线程使用同一个内存空间，短暂阻塞主线程）
- 子线程遍历内存数据，并开始重写的aof文件
- 主线程将操作命令，分别追加到原来的aof缓存区和新的aof重写缓存区
- 子线程完成重写后，会通知主线程，此时会将aof重写
缓存区的数据追加到重写文件中，然后原子地替换掉旧的aof文件

#### 载入
- 创建一个本地的redis伪客户端（不带网络连接）
- redis服务端分析并读取aof的一条写命令
- 由redis伪客户端执行该写命令
- 重复步骤，直到aof文件读完

## RDB-AOF混合持久化（Redis4.0新增）

### 原理
- 当开启混合模式时，fork出的子进程先将共享的内存副本全量`以RDB的方式写入AOF`，这样提高了速度也极大的缩小了aof文件（毕竟都是二进制）
- 也就是说这种模式下的aof文件发生rewrite后`前半部分是rdb格式`（REDIS开头的二进制数据），`后半部分是正常的aof追加的命令`（重写缓冲区里的）

### 优点
- 混合持久化结合了RDB持久化 和 AOF 持久化的优点，采取了rdb的文件小易于灾难恢复，同时结合AOF，增量的数据以AOF方式保存了，数据更少的丢失

### 缺点
- 兼容性差，一旦开启了混合持久化，在4.0之前版本都不识别该aof文件，同时由于前部分是RDB格式，需要专业的工具来阅读，因为是二进制，所以阅读性较差

### 参数

	aof-use-rdb-preamble yes #开启混合持久化（默认开启）
