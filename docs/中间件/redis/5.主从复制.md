### 设置主服务器的地址和端口
- 命令 slaveof ip port

### 建立socket连接

### ping
- 从服务器发送ping
- 若收到主服务器的pong，可以继续下一步
- 若读取pong超时或者收到主服务器返回错误，断开并重连

### 身份验证
- 主服务器没有设置requirepass，从服务器没有设置masterauth，可以继续下一步
- 主服务器设置的requirepass和从服务器设置的masterauth相同，可以继续下一步
- 其他情况重试

### 从服务器发送端口信息
- 主服务器纪录从服务器的信息
- slave0:ip=127.0.0.1,port=6382,state=online,offset=320339289,lag＝0
    - **offset：** 偏移值
    - **lag：** 收到心跳的间隔（秒）

### 同步
- **偏移值：** 主服务器每次传播给从服务器N个字节的数据，偏移值就增加N，从服务器每次收到主服务器的N个字节，偏移值就增加N
- **复制积压缓冲区：** 主服务器维护的一个队列（缓存最新的写命令），长度固定（默认为1MB），若队列满了，旧数据会从队头弹出，新数据会从队尾插入
- **runid：** 服务启动的时候自动生成，由40个随机的16进制字符串组成

#### 完整同步
- 当从服务器没同步过其他主服务器时，发送`psync ? -1`请求完整同步
- 当从服务器已经同步过其他主服务器时，发送`psync runid offset`，若主从服务器的runid不一致或者复制积压缓冲区里已经没有offset之后的数据，触发完整同步
- 收到PSYNC命令的主服务器执行BGSAVE命令，在后台生成一个RDB文件。并用一个缓冲区来记录从现在开始执行的所有写命令
- 当主服务器的BGSAVE命令执行完后，将生成的RDB文件发送给从服务器，从服务器接收和载入RDB文件。将自己的数据库状态更新至与主服务器执行BGSAVE命令时的状态
- 主服务器将所有缓冲区的写命令发送给从服务器，从服务器执行这些写命令，达到数据最终一致性

#### 完整同步小知识
- BGSAVE命令， 用于在后台异步保存当前数据库的数据到磁盘
- slave 会先写入本地磁盘，然后再从本地磁盘加载到内存，在加载RDB过程中会对外不可用
- 初次同步时会全量复制master节点的所有数据
- master node 将 rdb 快照文件发送给 slave node，如果 rdb 复制时间超过 60秒（repl-timeout），那么 slave node 就会认为复制失败，可以适当调大这个参数
- master 在内存中直接创建 RDB，然后发送给 slave，不会在自己本地落地磁盘了。只需要在配置文件中开启`repl-diskless-sync yes`
- slave 不会过期 key，只会等待 master 过期 key。如果 master 过期了一个 key，或者通过 LRU 淘汰了一个 key，那么会模拟一条 del 命令发送给 slave

#### 部分同步
- 当从服务器已经同步过其他主服务器时，发送`psync runid offset`，若主从服务器的runid相同而且复制积压缓冲区里存在offset之后的数据，触发部分同步
- 主服务器发送复制积压缓冲区里面的数据给从服务器，同步双方的数据，使得偏移值一致即可

### 命令传播
- 同步完成之后，主服务器会将写命令传给从服务器

### 心跳检测
- 从服务器默认每隔1s发送心跳信息给主服务器
- `replication ACK replication_offset`
    - 通过lag可以判断主从连接的网络状态是否正常（一般为0～1）
    - 通过replication_offset可以判断双方的数据是否同步
    - 通过`min-slaves-max-lag=10`和
    `min-slaves-to-write=1`可以限制主服务器在不稳定网络状态中的写入


        // 所有从服务器的心跳间隔都大于等于10时，不能写入
        min-slaves-max-lag=10
        // 从服务器的数量小于3时，不能写入
        min-slaves-to-write=3